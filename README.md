# `gleam_pb`

WIP protobuf support for `Gleam` âœ¨. 

---

`gleam_pb` wraps the excellent [gpb](https://github.com/tomas-abrahamsson/gpb) erlang library and generates idiomatic `Gleam` types ðŸ¤˜ 

## Progress

- [X] `Gleam` Type generation
  - [X] custom functions that better handle default values
  - [ ] stop including unnecessary imports
  - [ ] `gleam format` generated files
- [X] message encoding
- [X] message decoding
- [ ] improve UX
  - [ ] helper functions 
- [ ] grpc

## API

### Generated types

`gleam_pb` generally follows `gpb`'s type generation, but makes it easier to use from `Gleam`.

| `protobuf` | `gleam_pb` | `gpb` |
|---|---|---|
| double,float | Float | float() |
| int32, int64, uint32, uint64, sint32, sint64, fixed32, fixed64, sfixed32, sfixed64 | Int | integer() |
| bool | Bool | true \| false |
| enum | Zero Paramater Multi Constructor Type | atom() |
| message | Option(Custom Type) | record |
| string | String | unicode string |
| bytes | BitString | binary() |
| oneof | Option(Custom Type) with multiple Constructors | {chosen_field, value} |
| map | unordered list of tuples `[#(Key, Value)]` | `{field, value}` |

### Functions

`gleam_pb` generates functions to make using the types easier

- function to generate the message with protobuf's default values named `new_<snake_case_message_name>() -> <MessageType>`

- functions to encode and decode the messages
  - `encode_<snake_case_message_name>(m: <MessageType>) -> BitString`
  - `encode_<snake_case_message_name>(b: BitString) -> <MessageType>`

There are also several other functions intended for usage by `gleam_pb`

### Example

This message

```protobuf
syntax = "proto3";

package protos;

message Example {
    
    message Response {
        int32 val = 1;
        string user = 2;
    }

    enum OptionType {
        foo = 0;
        bar = 1;
        baz = 2;
    }

    repeated OptionType options = 1;

    oneof ResponseOrError {
        Response response = 2;
        string error = 3;
    }
}
```

Becomes

```rust
import gleam/option
import gleam/list
import gleam/pair
import gleam/dynamic
import gleam/erlang/atom
import gleam_pb

/// protos package types generated by gleam_pb
/// DO NOT EDIT
pub type OptionType {
  OptionTypefoo
  OptionTypebar
  OptionTypebaz
}

pub type ExampleResponseOrError {
  ResponseOrErrorresponse(response: option.Option(Response))
  ResponseOrErrorerror(error: String)
}

pub type Example {
  Example(
    options: List(OptionType),
    response_or_error: option.Option(ExampleResponseOrError),
  )
}

pub type Response {
  Response(val: Int, user: String)
}


/// functions continue ...
```

## Usage

For `gleam_pb` and `gpb` must be used together to generate working `Gleam` code. This process is in mind to improve in the future. 



Example Script

```bash
# install protoc-erl from `gpb`
protoc-erl -pkgs -modname gleam_gpb -I protos/*.proto -o ./src
# make sure protoc-gen-gleam is in you're path or add it manually using `--plugin`
protoc --plugin=protoc-gen-gleam -I . --gleam_out="src" protos/*.proto
```

### Issues

You may need to manually update the `-include("gpb.hrl").` generated in `gleam_gpb.erl` to point to the correct header post `Gleam` compilation.